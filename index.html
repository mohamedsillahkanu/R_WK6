# üìÖ Week 6: Statistical Analysis for Malaria Data

This week, we will:
‚úÖ **Compare malaria case counts** using t-tests and ANOVA
‚úÖ **Explore relationships between variables** with correlation analysis
‚úÖ **Build predictive models** using linear regression
‚úÖ **Interpret statistical results** for public health decision-making

---

## 1Ô∏è‚É£ Comparing Malaria Data: t-tests and ANOVA

### Why Use Statistical Tests?
üìå **Statistical tests** help determine if observed differences between groups (e.g., regions, seasons, intervention groups) are likely due to chance or represent real differences.

### Step 1: Two-Sample t-tests

```r
# Load required packages
library(dplyr)
library(ggplot2)

# Load malaria dataset
malaria_data <- read.csv("malaria_data.csv")

# Compare malaria cases between two regions
region_A <- malaria_data %>% 
  filter(region == "Region A") %>%
  pull(cases)

region_B <- malaria_data %>% 
  filter(region == "Region B") %>%
  pull(cases)

# Perform t-test
t_test_result <- t.test(region_A, region_B)

print(t_test_result)
```

#### üîç Explanation:
‚úî `t.test()` compares the means of two groups
‚úî The p-value indicates whether the difference is statistically significant (typically p < 0.05)
‚úî The confidence interval shows the likely range for the true difference between means

---

### Step 2: Paired t-tests for Before-After Comparisons

```r
# Compare cases before and after an intervention
before_intervention <- malaria_data %>%
  filter(period == "Before") %>%
  pull(cases)

after_intervention <- malaria_data %>%
  filter(period == "After") %>%
  pull(cases)

# Perform paired t-test
paired_result <- t.test(before_intervention, after_intervention, paired = TRUE)

print(paired_result)

# Visualize the comparison
intervention_data <- data.frame(
  Period = rep(c("Before", "After"), each = length(before_intervention)),
  Cases = c(before_intervention, after_intervention)
)

ggplot(intervention_data, aes(x = Period, y = Cases, fill = Period)) +
  geom_boxplot() +
  labs(
    title = "Malaria Cases Before and After Intervention",
    y = "Number of Cases"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Paired")
```

#### üîç Explanation:
‚úî `paired = TRUE` indicates that we're comparing matched observations (e.g., same sites before and after)
‚úî Paired tests are more powerful when we have before-after measurements from the same units
‚úî Boxplots help visualize the distribution of cases in each period

---

### Step 3: ANOVA for Multiple Group Comparisons

```r
# One-way ANOVA to compare cases across multiple regions
anova_result <- aov(cases ~ region, data = malaria_data)
summary(anova_result)

# If ANOVA is significant, perform post-hoc tests to determine which groups differ
if(summary(anova_result)[[1]][["Pr(>F)"]][1] < 0.05) {
  posthoc <- TukeyHSD(anova_result)
  print(posthoc)
}

# Visualize the comparison
ggplot(malaria_data, aes(x = region, y = cases, fill = region)) +
  geom_boxplot() +
  labs(
    title = "Comparison of Malaria Cases Across Regions",
    x = "Region",
    y = "Number of Cases"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### üîç Explanation:
‚úî ANOVA (Analysis of Variance) tests if means differ across multiple groups
‚úî `summary(anova_result)` shows if there's a significant difference among the groups
‚úî `TukeyHSD()` performs pairwise comparisons to determine which specific groups differ
‚úî The boxplot visualizes the distribution of cases across regions

---

### Step 4: Two-way ANOVA for Multiple Factors

```r
# Two-way ANOVA to examine effects of region and season
two_way_anova <- aov(cases ~ region * season, data = malaria_data)
summary(two_way_anova)

# Interaction plot
interaction_data <- malaria_data %>%
  group_by(region, season) %>%
  summarise(mean_cases = mean(cases, na.rm = TRUE), .groups = "drop")

ggplot(interaction_data, aes(x = season, y = mean_cases, color = region, group = region)) +
  geom_line() +
  geom_point(size = 3) +
  labs(
    title = "Interaction Between Region and Season on Malaria Cases",
    x = "Season",
    y = "Mean Number of Cases",
    color = "Region"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî Two-way ANOVA examines the effects of two factors and their interaction
‚úî `region * season` tests for main effects of each factor and their interaction
‚úî Significant interaction means the effect of one factor depends on the level of the other
‚úî The interaction plot visualizes how the relationship between cases and season varies by region

---

## 2Ô∏è‚É£ Correlation Analysis for Malaria Data

### Step 1: Basic Correlation Analysis

```r
# Calculate correlations between malaria cases and environmental factors
correlation_data <- malaria_data %>%
  select(cases, rainfall_mm, temperature_c, humidity_pct, altitude_m)

# Compute correlation matrix
cor_matrix <- cor(correlation_data, use = "pairwise.complete.obs")
print(cor_matrix)

# Test for significance of correlations
cor_test <- cor.test(malaria_data$cases, malaria_data$rainfall_mm)
print(cor_test)
```

#### üîç Explanation:
‚úî `cor()` calculates Pearson's correlation coefficient between variables
‚úî Values range from -1 (perfect negative correlation) to +1 (perfect positive correlation)
‚úî `use = "pairwise.complete.obs"` handles missing values by using all available pairs
‚úî `cor.test()` determines if a correlation is statistically significant

---

### Step 2: Visualizing Correlations

```r
# Load required packages
library(corrplot)

# Create a correlation plot
corrplot(cor_matrix, method = "circle", type = "upper", 
         tl.col = "black", tl.srt = 45,
         title = "Correlations Between Malaria Cases and Environmental Factors")

# Create scatter plots for key relationships
ggplot(malaria_data, aes(x = rainfall_mm, y = cases)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", color = "red") +
  labs(
    title = "Relationship Between Rainfall and Malaria Cases",
    x = "Rainfall (mm)",
    y = "Number of Cases"
  ) +
  theme_minimal()

# Create a pairs plot for multiple variables
library(GGally)
ggpairs(correlation_data)
```

#### üîç Explanation:
‚úî `corrplot()` creates a visualization of the correlation matrix
‚úî Circle size and color intensity represent correlation strength
‚úî Scatter plots with trend lines show the relationship between variables
‚úî `ggpairs()` creates a matrix of scatter plots, density plots, and correlation values

---

### Step 3: Exploring Seasonal Correlations

```r
# Analyze correlation by season
seasonal_correlations <- malaria_data %>%
  group_by(season) %>%
  summarise(
    rainfall_cor = cor(cases, rainfall_mm, use = "pairwise.complete.obs"),
    temp_cor = cor(cases, temperature_c, use = "pairwise.complete.obs"),
    humidity_cor = cor(cases, humidity_pct, use = "pairwise.complete.obs")
  )

print(seasonal_correlations)

# Visualize seasonal differences in correlations
library(tidyr)

seasonal_cor_long <- seasonal_correlations %>%
  pivot_longer(
    cols = c(rainfall_cor, temp_cor, humidity_cor),
    names_to = "factor",
    values_to = "correlation"
  ) %>%
  mutate(factor = case_when(
    factor == "rainfall_cor" ~ "Rainfall",
    factor == "temp_cor" ~ "Temperature",
    factor == "humidity_cor" ~ "Humidity"
  ))

ggplot(seasonal_cor_long, aes(x = season, y = correlation, fill = factor)) +
  geom_col(position = "dodge") +
  labs(
    title = "Seasonal Variation in Correlations with Malaria Cases",
    x = "Season",
    y = "Correlation Coefficient",
    fill = "Environmental Factor"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2")
```

#### üîç Explanation:
‚úî Grouping by season allows us to examine how correlations vary across seasons
‚úî `pivot_longer()` reshapes the data for easier visualization
‚úî The bar chart shows how the relationship between cases and environmental factors changes seasonally
‚úî This helps identify which factors are most important in different seasons

---

## 3Ô∏è‚É£ Linear Regression Models for Malaria Data

### Step 1: Simple Linear Regression

```r
# Build a simple linear regression model
simple_model <- lm(cases ~ rainfall_mm, data = malaria_data)

# View model summary
summary(simple_model)

# Visualize the regression line
ggplot(malaria_data, aes(x = rainfall_mm, y = cases)) +
  geom_point() +
  geom_smooth(method = "lm", color = "blue") +
  labs(
    title = "Linear Regression: Malaria Cases vs. Rainfall",
    x = "Rainfall (mm)",
    y = "Number of Cases"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî `lm()` fits a linear regression model with cases as the outcome and rainfall as the predictor
‚úî `summary()` provides the coefficient estimates, p-values, and R-squared value
‚úî The coefficient for rainfall indicates the change in cases for each 1mm increase in rainfall
‚úî R-squared indicates the proportion of variance in cases explained by rainfall

---

### Step 2: Multiple Linear Regression

```r
# Build a multiple regression model
multiple_model <- lm(cases ~ rainfall_mm + temperature_c + humidity_pct, 
                    data = malaria_data)

# View model summary
summary(multiple_model)

# Compare models using ANOVA
anova(simple_model, multiple_model)

# Calculate variance inflation factors to check for multicollinearity
library(car)
vif(multiple_model)
```

#### üîç Explanation:
‚úî Multiple regression includes several predictors in the same model
‚úî Each coefficient represents the effect of that variable while controlling for the others
‚úî `anova()` tests whether the multiple model significantly improves over the simpler model
‚úî Variance Inflation Factor (VIF) detects multicollinearity (high correlation between predictors)
‚úî VIF values > 5-10 suggest problematic multicollinearity

---

### Step 3: Adding Categorical Predictors

```r
# Create a model with categorical and continuous predictors
category_model <- lm(cases ~ rainfall_mm + temperature_c + region + season, 
                    data = malaria_data)

# View model summary
summary(category_model)

# Visualize the model predictions by region
malaria_data$predicted_cases <- predict(category_model)

ggplot(malaria_data, aes(x = rainfall_mm, y = cases, color = region)) +
  geom_point(alpha = 0.6) +
  geom_line(aes(y = predicted_cases)) +
  facet_wrap(~season) +
  labs(
    title = "Predicted Malaria Cases by Region and Season",
    x = "Rainfall (mm)",
    y = "Number of Cases",
    color = "Region"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî Categorical variables like region and season are automatically converted to dummy variables
‚úî The coefficients represent the difference in cases relative to the reference category
‚úî `predict()` generates predicted values based on the model
‚úî Faceting by season shows how the rainfall-cases relationship varies seasonally and by region

---

### Step 4: Model Diagnostics and Refinement

```r
# Check model assumptions
par(mfrow = c(2, 2))
plot(category_model)
par(mfrow = c(1, 1))

# Test for influential observations
influential <- influence.measures(category_model)
summary(influential)

# Consider a log transformation if data is skewed
log_model <- lm(log(cases + 1) ~ rainfall_mm + temperature_c + region + season, 
               data = malaria_data)

summary(log_model)

# Compare AIC values
AIC(category_model, log_model)
```

#### üîç Explanation:
‚úî Diagnostic plots check assumptions: linearity, normality, constant variance, influential points
‚úî Influence measures identify observations that disproportionately affect the model
‚úî Log transformation can help when the outcome variable is right-skewed
‚úî AIC (Akaike Information Criterion) helps compare models - lower values indicate better fit

---

## 4Ô∏è‚É£ Interpreting Results for Public Health Decision-Making

### Step 1: Calculating Predicted Cases 

```r
# Create a scenario dataset for prediction
scenario_data <- expand.grid(
  rainfall_mm = seq(min(malaria_data$rainfall_mm), 
                   max(malaria_data$rainfall_mm), 
                   length.out = 5),
  temperature_c = mean(malaria_data$temperature_c),
  region = unique(malaria_data$region),
  season = "Rainy"
)

# Generate predictions with confidence intervals
predictions <- predict(category_model, newdata = scenario_data, 
                      interval = "confidence", level = 0.95)

# Combine with scenario data
scenario_data <- cbind(scenario_data, predictions)

# Display predictions
print(scenario_data)
```

#### üîç Explanation:
‚úî `expand.grid()` creates a dataset with combinations of predictor values
‚úî `predict()` with `interval = "confidence"` provides confidence intervals for predictions
‚úî This shows the expected number of cases under different rainfall scenarios
‚úî Confidence intervals indicate the uncertainty in our predictions

---

### Step 2: Identifying Risk Factors

```r
# Calculate standardized coefficients
library(lm.beta)
std_coef <- lm.beta(category_model)
summary(std_coef)

# Forest plot of coefficients
library(ggplot2)
library(broom)

coef_data <- tidy(category_model) %>%
  filter(term != "(Intercept)") %>%
  mutate(
    lower = estimate - 1.96 * std.error,
    upper = estimate + 1.96 * std.error
  )

ggplot(coef_data, aes(x = estimate, y = term, xmin = lower, xmax = upper)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbarh(height = 0.3) +
  geom_point(size = 3) +
  labs(
    title = "Risk Factors for Malaria Cases",
    x = "Coefficient Estimate",
    y = "Predictor"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî Standardized coefficients allow comparison of variables with different scales
‚úî Forest plots visualize coefficient estimates and their confidence intervals
‚úî Predictors with intervals that don't cross zero are statistically significant
‚úî The size of the coefficient indicates the strength of the association

---

### Step 3: Intervention Planning

```r
# Calculate threshold values for high-risk scenarios
threshold_model <- lm(cases ~ rainfall_mm + temperature_c, data = malaria_data)

# Find rainfall threshold for expected cases > 100
threshold_cases <- 100
intercept <- coef(threshold_model)[1]
rainfall_coef <- coef(threshold_model)[2]
temp_coef <- coef(threshold_model)[3]
mean_temp <- mean(malaria_data$temperature_c)

rainfall_threshold <- (threshold_cases - intercept - temp_coef * mean_temp) / rainfall_coef

cat("Rainfall threshold for high malaria risk (>100 cases):", 
    round(rainfall_threshold, 1), "mm\n")

# Create a risk classification function
classify_risk <- function(rainfall, temperature) {
  expected_cases <- predict(threshold_model, 
                           newdata = data.frame(rainfall_mm = rainfall,
                                              temperature_c = temperature))
  
  if(expected_cases < 50) {
    return("Low Risk")
  } else if(expected_cases < 100) {
    return("Medium Risk")
  } else {
    return("High Risk")
  }
}

# Create a risk map for various rainfall and temperature combinations
risk_grid <- expand.grid(
  rainfall_mm = seq(min(malaria_data$rainfall_mm),
                   max(malaria_data$rainfall_mm),
                   length.out = 20),
  temperature_c = seq(min(malaria_data$temperature_c),
                     max(malaria_data$temperature_c),
                     length.out = 20)
)

risk_grid$expected_cases <- predict(threshold_model, newdata = risk_grid)
risk_grid$risk_level <- factor(ifelse(risk_grid$expected_cases < 50, "Low Risk",
                                    ifelse(risk_grid$expected_cases < 100, "Medium Risk", 
                                          "High Risk")),
                             levels = c("Low Risk", "Medium Risk", "High Risk"))

ggplot(risk_grid, aes(x = rainfall_mm, y = temperature_c, fill = risk_level)) +
  geom_tile() +
  scale_fill_manual(values = c("Low Risk" = "green", 
                              "Medium Risk" = "yellow", 
                              "High Risk" = "red")) +
  labs(
    title = "Malaria Risk Levels by Rainfall and Temperature",
    x = "Rainfall (mm)",
    y = "Temperature (¬∞C)",
    fill = "Risk Level"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî We can use models to determine threshold values for high-risk conditions
‚úî The risk classification function applies our model to categorize scenarios
‚úî The risk map visualizes how different combinations of rainfall and temperature affect risk
‚úî This information can guide when and where to implement enhanced surveillance and control

---

### Step 4: Communicating Statistical Results

```r
# Create a summary table of key findings
library(knitr)
library(kableExtra)

key_findings <- data.frame(
  Finding = c(
    "Correlation between rainfall and cases",
    "Effect of 10mm increase in rainfall",
    "Difference between wet and dry seasons",
    "Most significant environmental predictor",
    "Region with highest adjusted risk",
    "Model predictive accuracy (R-squared)"
  ),
  
  Value = c(
    sprintf("r = %.2f (p = %.3f)", cor(malaria_data$rainfall_mm, malaria_data$cases, 
                                      use = "pairwise.complete.obs"),
           cor.test(malaria_data$rainfall_mm, malaria_data$cases)$p.value),
    sprintf("%.1f additional cases", coef(category_model)["rainfall_mm"] * 10),
    sprintf("%.1f more cases in wet season", coef(category_model)["seasonWet"]),
    names(which.max(abs(lm.beta(category_model)$standardized.coefficients[-1]))),
    names(which.max(tapply(residuals(category_model), malaria_data$region, mean))),
    sprintf("%.1f%%", summary(category_model)$r.squared * 100)
  )
)

kable(key_findings, col.names = c("Key Finding", "Result")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

#### üîç Explanation:
‚úî Summary tables present key findings in an accessible format for non-statisticians
‚úî Including both statistical values and plain-language interpretations
‚úî Focus on findings relevant to public health decision-making
‚úî This information can be included in reports for stakeholders and policymakers

---

## ‚úÖ Summary of Week 6

By the end of Week 6, you should be able to:
‚úî **Apply appropriate statistical tests** (t-tests, ANOVA) to compare malaria data across groups
‚úî **Identify significant correlations** between malaria cases and environmental factors
‚úî **Build regression models** to predict malaria cases based on multiple variables
‚úî **Interpret statistical results** to guide public health interventions



