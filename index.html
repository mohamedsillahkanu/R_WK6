# üìÖ Week 6: Statistical Analysis for Malaria Data

This week, we will:
‚úÖ **Compare malaria case counts** using t-tests and ANOVA
‚úÖ **Explore relationships between variables** with correlation analysis
‚úÖ **Build predictive models** using linear regression
‚úÖ **Interpret statistical results** for public health decision-making

---

## 1Ô∏è‚É£ Comparing Malaria Data: t-tests and ANOVA

### Why Use Statistical Tests?
üìå **Statistical tests** help determine if observed differences between groups (e.g., regions, seasons, intervention groups) are likely due to chance or represent real differences.

### Step 1: Two-Sample t-tests

```r
# Load required packages
library(dplyr)
library(ggplot2)

# Load malaria dataset
malaria_data <- read.csv("malaria_data.csv")

# Compare malaria cases between two regions
region_A <- malaria_data %>% 
  filter(region == "Region A") %>%
  pull(cases)

region_B <- malaria_data %>% 
  filter(region == "Region B") %>%
  pull(cases)

# Perform t-test
t_test_result <- t.test(region_A, region_B)

print(t_test_result)
```

#### üîç Explanation:
‚úî `t.test()` compares the means of two groups
‚úî The p-value indicates whether the difference is statistically significant (typically p < 0.05)
‚úî The confidence interval shows the likely range for the true difference between means

---

### Step 2: Paired t-tests for Before-After Comparisons

```r
# Compare cases before and after an intervention
before_intervention <- malaria_data %>%
  filter(period == "Before") %>%
  pull(cases)

after_intervention <- malaria_data %>%
  filter(period == "After") %>%
  pull(cases)

# Perform paired t-test
paired_result <- t.test(before_intervention, after_intervention, paired = TRUE)

print(paired_result)

# Visualize the comparison
intervention_data <- data.frame(
  Period = rep(c("Before", "After"), each = length(before_intervention)),
  Cases = c(before_intervention, after_intervention)
)

ggplot(intervention_data, aes(x = Period, y = Cases, fill = Period)) +
  geom_boxplot() +
  labs(
    title = "Malaria Cases Before and After Intervention",
    y = "Number of Cases"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Paired")
```

#### üîç Explanation:
‚úî `paired = TRUE` indicates that we're comparing matched observations (e.g., same sites before and after)
‚úî Paired tests are more powerful when we have before-after measurements from the same units
‚úî Boxplots help visualize the distribution of cases in each period

---

### Step 3: ANOVA for Multiple Group Comparisons

```r
# One-way ANOVA to compare cases across multiple regions
anova_result <- aov(cases ~ region, data = malaria_data)
summary(anova_result)

# If ANOVA is significant, perform post-hoc tests to determine which groups differ
if(summary(anova_result)[[1]][["Pr(>F)"]][1] < 0.05) {
  posthoc <- TukeyHSD(anova_result)
  print(posthoc)
}

# Visualize the comparison
ggplot(malaria_data, aes(x = region, y = cases, fill = region)) +
  geom_boxplot() +
  labs(
    title = "Comparison of Malaria Cases Across Regions",
    x = "Region",
    y = "Number of Cases"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### üîç Explanation:
‚úî ANOVA (Analysis of Variance) tests if means differ across multiple groups
‚úî `summary(anova_result)` shows if there's a significant difference among the groups
‚úî `TukeyHSD()` performs pairwise comparisons to determine which specific groups differ
‚úî The boxplot visualizes the distribution of cases across regions

---

### Step 4: Two-way ANOVA for Multiple Factors

```r
# Two-way ANOVA to examine effects of region and season
two_way_anova <- aov(cases ~ region * season, data = malaria_data)
summary(two_way_anova)

# Interaction plot
interaction_data <- malaria_data %>%
  group_by(region, season) %>%
  summarise(mean_cases = mean(cases, na.rm = TRUE), .groups = "drop")

ggplot(interaction_data, aes(x = season, y = mean_cases, color = region, group = region)) +
  geom_line() +
  geom_point(size = 3) +
  labs(
    title = "Interaction Between Region and Season on Malaria Cases",
    x = "Season",
    y = "Mean Number of Cases",
    color = "Region"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî Two-way ANOVA examines the effects of two factors and their interaction
‚úî `region * season` tests for main effects of each factor and their interaction
‚úî Significant interaction means the effect of one factor depends on the level of the other
‚úî The interaction plot visualizes how the relationship between cases and season varies by region

---

## 2Ô∏è‚É£ Correlation Analysis for Malaria Data

### Step 1: Basic Correlation Analysis

```r
# Calculate correlations between malaria cases and environmental factors
correlation_data <- malaria_data %>%
  select(cases, rainfall_mm, temperature_c, humidity_pct, altitude_m)

# Compute correlation matrix
cor_matrix <- cor(correlation_data, use = "pairwise.complete.obs")
print(cor_matrix)

# Test for significance of correlations
cor_test <- cor.test(malaria_data$cases, malaria_data$rainfall_mm)
print(cor_test)
```

#### üîç Explanation:
‚úî `cor()` calculates Pearson's correlation coefficient between variables
‚úî Values range from -1 (perfect negative correlation) to +1 (perfect positive correlation)
‚úî `use = "pairwise.complete.obs"` handles missing values by using all available pairs
‚úî `cor.test()` determines if a correlation is statistically significant

---

### Step 2: Visualizing Correlations

```r
# Load required packages
library(corrplot)

# Create a correlation plot
corrplot(cor_matrix, method = "circle", type = "upper", 
         tl.col = "black", tl.srt = 45,
         title = "Correlations Between Malaria Cases and Environmental Factors")

# Create scatter plots for key relationships
ggplot(malaria_data, aes(x = rainfall_mm, y = cases)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", color = "red") +
  labs(
    title = "Relationship Between Rainfall and Malaria Cases",
    x = "Rainfall (mm)",
    y = "Number of Cases"
  ) +
  theme_minimal()

# Create a pairs plot for multiple variables
library(GGally)
ggpairs(correlation_data)
```

#### üîç Explanation:
‚úî `corrplot()` creates a visualization of the correlation matrix
‚úî Circle size and color intensity represent correlation strength
‚úî Scatter plots with trend lines show the relationship between variables
‚úî `ggpairs()` creates a matrix of scatter plots, density plots, and correlation values

---

### Step 3: Exploring Seasonal Correlations

```r
# Analyze correlation by season
seasonal_correlations <- malaria_data %>%
  group_by(season) %>%
  summarise(
    rainfall_cor = cor(cases, rainfall_mm, use = "pairwise.complete.obs"),
    temp_cor = cor(cases, temperature_c, use = "pairwise.complete.obs"),
    humidity_cor = cor(cases, humidity_pct, use = "pairwise.complete.obs")
  )

print(seasonal_correlations)

# Visualize seasonal differences in correlations
library(tidyr)

seasonal_cor_long <- seasonal_correlations %>%
  pivot_longer(
    cols = c(rainfall_cor, temp_cor, humidity_cor),
    names_to = "factor",
    values_to = "correlation"
  ) %>%
  mutate(factor = case_when(
    factor == "rainfall_cor" ~ "Rainfall",
    factor == "temp_cor" ~ "Temperature",
    factor == "humidity_cor" ~ "Humidity"
  ))

ggplot(seasonal_cor_long, aes(x = season, y = correlation, fill = factor)) +
  geom_col(position = "dodge") +
  labs(
    title = "Seasonal Variation in Correlations with Malaria Cases",
    x = "Season",
    y = "Correlation Coefficient",
    fill = "Environmental Factor"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2")
```

#### üîç Explanation:
‚úî Grouping by season allows us to examine how correlations vary across seasons
‚úî `pivot_longer()` reshapes the data for easier visualization
‚úî The bar chart shows how the relationship between cases and environmental factors changes seasonally
‚úî This helps identify which factors are most important in different seasons

---

## 3Ô∏è‚É£ Linear Regression Models for Malaria Data

### Step 1: Simple Linear Regression

```r
# Build a simple linear regression model
simple_model <- lm(cases ~ rainfall_mm, data = malaria_data)

# View model summary
summary(simple_model)

# Visualize the regression line
ggplot(malaria_data, aes(x = rainfall_mm, y = cases)) +
  geom_point() +
  geom_smooth(method = "lm", color = "blue") +
  labs(
    title = "Linear Regression: Malaria Cases vs. Rainfall",
    x = "Rainfall (mm)",
    y = "Number of Cases"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî `lm()` fits a linear regression model with cases as the outcome and rainfall as the predictor
‚úî `summary()` provides the coefficient estimates, p-values, and R-squared value
‚úî The coefficient for rainfall indicates the change in cases for each 1mm increase in rainfall
‚úî R-squared indicates the proportion of variance in cases explained by rainfall

---

### Step 2: Multiple Linear Regression

```r
# Build a multiple regression model
multiple_model <- lm(cases ~ rainfall_mm + temperature_c + humidity_pct, 
                    data = malaria_data)

# View model summary
summary(multiple_model)

# Compare models using ANOVA
anova(simple_model, multiple_model)

# Calculate variance inflation factors to check for multicollinearity
library(car)
vif(multiple_model)
```

#### üîç Explanation:
‚úî Multiple regression includes several predictors in the same model
‚úî Each coefficient represents the effect of that variable while controlling for the others
‚úî `anova()` tests whether the multiple model significantly improves over the simpler model
‚úî Variance Inflation Factor (VIF) detects multicollinearity (high correlation between predictors)
‚úî VIF values > 5-10 suggest problematic multicollinearity

---

### Step 3: Adding Categorical Predictors

```r
# Create a model with categorical and continuous predictors
category_model <- lm(cases ~ rainfall_mm + temperature_c + region + season, 
                    data = malaria_data)

# View model summary
summary(category_model)

# Visualize the model predictions by region
malaria_data$predicted_cases <- predict(category_model)

ggplot(malaria_data, aes(x = rainfall_mm, y = cases, color = region)) +
  geom_point(alpha = 0.6) +
  geom_line(aes(y = predicted_cases)) +
  facet_wrap(~season) +
  labs(
    title = "Predicted Malaria Cases by Region and Season",
    x = "Rainfall (mm)",
    y = "Number of Cases",
    color = "Region"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî Categorical variables like region and season are automatically converted to dummy variables
‚úî The coefficients represent the difference in cases relative to the reference category
‚úî `predict()` generates predicted values based on the model
‚úî Faceting by season shows how the rainfall-cases relationship varies seasonally and by region

---

### Step 4: Model Diagnostics and Refinement

```r
# Check model assumptions
par(mfrow = c(2, 2))
plot(category_model)
par(mfrow = c(1, 1))

# Test for influential observations
influential <- influence.measures(category_model)
summary(influential)

# Consider a log transformation if data is skewed
log_model <- lm(log(cases + 1) ~ rainfall_mm + temperature_c + region + season, 
               data = malaria_data)

summary(log_model)

# Compare AIC values
AIC(category_model, log_model)
```

#### üîç Explanation:
‚úî Diagnostic plots check assumptions: linearity, normality, constant variance, influential points
‚úî Influence measures identify observations that disproportionately affect the model
‚úî Log transformation can help when the outcome variable is right-skewed
‚úî AIC (Akaike Information Criterion) helps compare models - lower values indicate better fit

---

## 4Ô∏è‚É£ Interpreting Results for Public Health Decision-Making

### Step 1: Calculating Predicted Cases 

```r
# Create a scenario dataset for prediction
scenario_data <- expand.grid(
  rainfall_mm = seq(min(malaria_data$rainfall_mm), 
                   max(malaria_data$rainfall_mm), 
                   length.out = 5),
  temperature_c = mean(malaria_data$temperature_c),
  region = unique(malaria_data$region),
  season = "Rainy"
)

# Generate predictions with confidence intervals
predictions <- predict(category_model, newdata = scenario_data, 
                      interval = "confidence", level = 0.95)

# Combine with scenario data
scenario_data <- cbind(scenario_data, predictions)

# Display predictions
print(scenario_data)
```

#### üîç Explanation:
‚úî `expand.grid()` creates a dataset with combinations of predictor values
‚úî `predict()` with `interval = "confidence"` provides confidence intervals for predictions
‚úî This shows the expected number of cases under different rainfall scenarios
‚úî Confidence intervals indicate the uncertainty in our predictions

---

### Step 2: Identifying Risk Factors

```r
# Calculate standardized coefficients
library(lm.beta)
std_coef <- lm.beta(category_model)
summary(std_coef)

# Forest plot of coefficients
library(ggplot2)
library(broom)

coef_data <- tidy(category_model) %>%
  filter(term != "(Intercept)") %>%
  mutate(
    lower = estimate - 1.96 * std.error,
    upper = estimate + 1.96 * std.error
  )

ggplot(coef_data, aes(x = estimate, y = term, xmin = lower, xmax = upper)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbarh(height = 0.3) +
  geom_point(size = 3) +
  labs(
    title = "Risk Factors for Malaria Cases",
    x = "Coefficient Estimate",
    y = "Predictor"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî Standardized coefficients allow comparison of variables with different scales
‚úî Forest plots visualize coefficient estimates and their confidence intervals
‚úî Predictors with intervals that don't cross zero are statistically significant
‚úî The size of the coefficient indicates the strength of the association

---

### Step 3: Intervention Planning

```r
# Calculate threshold values for high-risk scenarios
threshold_model <- lm(cases ~ rainfall_mm + temperature_c, data = malaria_data)

# Find rainfall threshold for expected cases > 100
threshold_cases <- 100
intercept <- coef(threshold_model)[1]
rainfall_coef <- coef(threshold_model)[2]
temp_coef <- coef(threshold_model)[3]
mean_temp <- mean(malaria_data$temperature_c)

rainfall_threshold <- (threshold_cases - intercept - temp_coef * mean_temp) / rainfall_coef

cat("Rainfall threshold for high malaria risk (>100 cases):", 
    round(rainfall_threshold, 1), "mm\n")

# Create a risk classification function
classify_risk <- function(rainfall, temperature) {
  expected_cases <- predict(threshold_model, 
                           newdata = data.frame(rainfall_mm = rainfall,
                                              temperature_c = temperature))
  
  if(expected_cases < 50) {
    return("Low Risk")
  } else if(expected_cases < 100) {
    return("Medium Risk")
  } else {
    return("High Risk")
  }
}

# Create a risk map for various rainfall and temperature combinations
risk_grid <- expand.grid(
  rainfall_mm = seq(min(malaria_data$rainfall_mm),
                   max(malaria_data$rainfall_mm),
                   length.out = 20),
  temperature_c = seq(min(malaria_data$temperature_c),
                     max(malaria_data$temperature_c),
                     length.out = 20)
)

risk_grid$expected_cases <- predict(threshold_model, newdata = risk_grid)
risk_grid$risk_level <- factor(ifelse(risk_grid$expected_cases < 50, "Low Risk",
                                    ifelse(risk_grid$expected_cases < 100, "Medium Risk", 
                                          "High Risk")),
                             levels = c("Low Risk", "Medium Risk", "High Risk"))

ggplot(risk_grid, aes(x = rainfall_mm, y = temperature_c, fill = risk_level)) +
  geom_tile() +
  scale_fill_manual(values = c("Low Risk" = "green", 
                              "Medium Risk" = "yellow", 
                              "High Risk" = "red")) +
  labs(
    title = "Malaria Risk Levels by Rainfall and Temperature",
    x = "Rainfall (mm)",
    y = "Temperature (¬∞C)",
    fill = "Risk Level"
  ) +
  theme_minimal()
```

#### üîç Explanation:
‚úî We can use models to determine threshold values for high-risk conditions
‚úî The risk classification function applies our model to categorize scenarios
‚úî The risk map visualizes how different combinations of rainfall and temperature affect risk
‚úî This information can guide when and where to implement enhanced surveillance and control

---

### Step 4: Communicating Statistical Results

```r
# Create a summary table of key findings
library(knitr)
library(kableExtra)

key_findings <- data.frame(
  Finding = c(
    "Correlation between rainfall and cases",
    "Effect of 10mm increase in rainfall",
    "Difference between wet and dry seasons",
    "Most significant environmental predictor",
    "Region with highest adjusted risk",
    "Model predictive accuracy (R-squared)"
  ),
  
  Value = c(
    sprintf("r = %.2f (p = %.3f)", cor(malaria_data$rainfall_mm, malaria_data$cases, 
                                      use = "pairwise.complete.obs"),
           cor.test(malaria_data$rainfall_mm, malaria_data$cases)$p.value),
    sprintf("%.1f additional cases", coef(category_model)["rainfall_mm"] * 10),
    sprintf("%.1f more cases in wet season", coef(category_model)["seasonWet"]),
    names(which.max(abs(lm.beta(category_model)$standardized.coefficients[-1]))),
    names(which.max(tapply(residuals(category_model), malaria_data$region, mean))),
    sprintf("%.1f%%", summary(category_model)$r.squared * 100)
  )
)

kable(key_findings, col.names = c("Key Finding", "Result")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

#### üîç Explanation:
‚úî Summary tables present key findings in an accessible format for non-statisticians
‚úî Including both statistical values and plain-language interpretations
‚úî Focus on findings relevant to public health decision-making
‚úî This information can be included in reports for stakeholders and policymakers

---

## ‚úÖ Summary of Week 6

By the end of Week 6, you should be able to:
‚úî **Apply appropriate statistical tests** (t-tests, ANOVA) to compare malaria data across groups
‚úî **Identify significant correlations** between malaria cases and environmental factors
‚úî **Build regression models** to predict malaria cases based on multiple variables
‚úî **Interpret statistical results** to guide public health interventions

This statistical toolkit will enable you to answer critical questions about malaria transmission patterns, identify risk factors, evaluate interventions, and develop evidence-based strategies for malaria control.

---

## üí° What's Next?

‚úî After completing Week 6, you have learned to apply statistical methods to analyze malaria data.
‚úî In **Week 7**, we will explore machine learning techniques for malaria prediction, including classification, clustering, and time-series forecasting.

---

# üìå Week 6: Exercises ‚Äì Statistical Analysis for Malaria Data

These exercises will help you practice applying statistical tests, analyzing correlations, building regression models, and interpreting results for malaria data.

---

## 1Ô∏è‚É£ Comparing Malaria Data: t-tests and ANOVA

### Exercise 1.1: Basic Comparative Tests
üîπ **Using the `malaria_analysis` dataset, complete the following tasks:**

**Write the R code to:**
1. Test if there is a significant difference in malaria cases between urban and rural areas.
2. Compare malaria incidence rates before and after the introduction of insecticide-treated bed nets.
3. Determine if the mean number of cases differs significantly between the wet and dry seasons.
4. Create appropriate visualizations to display these comparisons.

---

### Exercise 1.2: Multiple Group Comparisons
üîπ **Use ANOVA to compare cases across different groups.**

**Write the R code to:**
1. Perform a one-way ANOVA to test if mean malaria cases differ across four regions.
2. Conduct post-hoc tests to identify which specific regions differ from each other.
3. Create a visualization showing the distribution of malaria cases across regions.
4. Calculate and display the mean and 95% confidence intervals for each region.

---

### Exercise 1.3: Interaction Effects

```r
# Two-way ANOVA for region and season
interaction_model <- aov(cases ~ region * season, data = malaria_analysis)
summary(interaction_model)

# Prepare data for interaction plot
interaction_data <- malaria_analysis %>%
  group_by(region, season) %>%
  summarise(
    mean_cases = mean(cases, na.rm = TRUE),
    se = sd(cases, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Create interaction plot
ggplot(interaction_data, aes(x = season, y = mean_cases, color = region, group = region)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_cases - se, ymax = mean_cases + se), width = 0.2) +
  labs(
    title = "Interaction Between Region and Season on Malaria Cases",
    x = "Season",
    y = "Mean Number of Cases",
    color = "Region"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1")

# Alternative visualization: faceted bar chart
ggplot(interaction_data, aes(x = season, y = mean_cases, fill = season)) +
  geom_col() +
  geom_errorbar(aes(ymin = mean_cases - se, ymax = mean_cases + se), width = 0.2) +
  facet_wrap(~region) +
  labs(
    title = "Seasonal Effect on Malaria Cases by Region",
    x = "Season",
    y = "Mean Number of Cases"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("Dry" = "#D55E00", "Wet" = "#0072B2"))
```

#### Explanation:
- Two-way ANOVA examines effects of two factors (region and season) and their interaction
- A significant interaction means the seasonal effect differs across regions
- The interaction plot shows how seasonal patterns vary by region
- Crossing or non-parallel lines in the interaction plot indicate an interaction effect
- This information helps tailor seasonal malaria control strategies to specific regions
üîπ **Explore interactions between multiple factors.**

**Write the R code to:**
1. Conduct a two-way ANOVA to test the effects of region and season on malaria cases.
2. Test if the seasonal effect on malaria cases differs by region (interaction effect).
3. Create an interaction plot to visualize how the seasonal pattern varies across regions.
4. Interpret the practical significance of any interaction effects for malaria control.

---

## 2Ô∏è‚É£ Correlation Analysis

### Exercise 2.1: Basic Correlation Analysis

```r
# Calculate correlations between malaria cases and environmental factors
env_vars <- c("rainfall_mm", "temperature_c", "humidity_pct", "altitude_m")

# Create correlation table
cor_results <- data.frame(
  Variable = env_vars,
  Correlation = sapply(env_vars, function(var) {
    cor(malaria_analysis$cases, malaria_analysis[[var]], 
        use = "pairwise.complete.obs")
  }),
  P_Value = sapply(env_vars, function(var) {
    cor.test(malaria_analysis$cases, malaria_analysis[[var]])$p.value
  })
)

cor_results$Significance <- ifelse(cor_results$P_Value < 0.001, "***",
                               ifelse(cor_results$P_Value < 0.01, "**",
                                   ifelse(cor_results$P_Value < 0.05, "*", "ns")))

print(cor_results)

# Create a correlation matrix for all variables
cor_vars <- c("cases", env_vars)
cor_matrix <- cor(malaria_analysis[cor_vars], use = "pairwise.complete.obs")
print(cor_matrix)

# Visualize correlation matrix as a heatmap
library(corrplot)
corrplot(cor_matrix, method = "color", type = "upper", 
         addCoef.col = "black", tl.col = "black", tl.srt = 45,
         col = colorRampPalette(c("#6D9EC1", "white", "#E46726"))(200),
         title = "Correlation Matrix: Malaria Cases and Environmental Factors")

# Create scatter plots for each environmental factor
library(gridExtra)

plot_list <- lapply(env_vars, function(var) {
  ggplot(malaria_analysis, aes_string(x = var, y = "cases")) +
    geom_point(alpha = 0.6) +
    geom_smooth(method = "loess", color = "red") +
    labs(
      title = paste("Cases vs", gsub("_", " ", var)),
      y = "Number of Cases"
    ) +
    theme_minimal()
})

grid.arrange(grobs = plot_list, ncol = 2)
```

#### Explanation:
- We calculate correlation coefficients between malaria cases and each environmental factor
- P-values indicate if the correlations are statistically significant
- The correlation matrix shows relationships between all pairs of variables
- The heatmap visualization makes it easy to identify strong (dark) vs. weak (light) correlations
- Scatter plots with trend lines show the shape of relationships (linear, non-linear)
üîπ **Explore relationships between malaria cases and environmental factors.**

**Write the R code to:**
1. Calculate the correlation between malaria cases and each of the following: rainfall, temperature, humidity, and altitude.
2. Test the statistical significance of each correlation.
3. Create a correlation matrix for all pairs of variables.
4. Generate a heat map visualization of the correlation matrix.

---

### Exercise 2.2: Temporal Correlation Patterns

```r
# Ensure data has proper date structure
malaria_analysis$date <- as.Date(paste(malaria_analysis$year, 
                                      malaria_analysis$month, 
                                      "01", sep = "-"))

# Calculate monthly correlations over time
monthly_cors <- malaria_analysis %>%
  group_by(month) %>%
  summarise(
    rainfall_cor = cor(cases, rainfall_mm, use = "pairwise.complete.obs"),
    temp_cor = cor(cases, temperature_c, use = "pairwise.complete.obs"),
    humidity_cor = cor(cases, humidity_pct, use = "pairwise.complete.obs")
  ) %>%
  mutate(month_name = month.name[month])

print(monthly_cors)

# Test for lag effects
lag_cors <- data.frame(
  Lag = 0:3,
  Correlation = sapply(0:3, function(lag) {
    lagged_data <- malaria_analysis %>%
      arrange(region, date) %>%
      group_by(region) %>%
      mutate(lagged_rainfall = lag(rainfall_mm, n = lag))
    
    cor(lagged_data$cases, lagged_data$lagged_rainfall, 
        use = "pairwise.complete.obs")
  })
)

print(lag_cors)

# Visualize monthly correlation patterns
library(tidyr)

monthly_cors_long <- monthly_cors %>%
  select(-month) %>%
  pivot_longer(
    cols = c(rainfall_cor, temp_cor, humidity_cor),
    names_to = "variable",
    values_to = "correlation"
  ) %>%
  mutate(
    variable = case_when(
      variable == "rainfall_cor" ~ "Rainfall",
      variable == "temp_cor" ~ "Temperature",
      variable == "humidity_cor" ~ "Humidity"
    ),
    month_name = factor(month_name, levels = month.name)
  )

ggplot(monthly_cors_long, aes(x = month_name, y = correlation, 
                            color = variable, group = variable)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  labs(
    title = "Monthly Correlation of Environmental Factors with Malaria Cases",
    x = "Month",
    y = "Correlation Coefficient",
    color = "Environmental\nFactor"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_brewer(palette = "Set1")

# Visualize lag effects
ggplot(lag_cors, aes(x = Lag, y = Correlation)) +
  geom_line(size = 1, color = "blue") +
  geom_point(size = 3, color = "blue") +
  labs(
    title = "Correlation Between Malaria Cases and Lagged Rainfall",
    x = "Lag (Months)",
    y = "Correlation Coefficient"
  ) +
  theme_minimal() +
  scale_x_continuous(breaks = 0:3)
```

#### Explanation:
- Monthly correlations show how relationships change throughout the year
- Lag analysis reveals if environmental factors have delayed effects on malaria
- A higher correlation at a specific lag suggests that rainfall affects malaria cases with that delay
- The line plot shows seasonal patterns in correlation strength
- This helps identify the optimal monitoring period for early warning systems
üîπ **Investigate how correlations change over time.**

**Write the R code to:**
1. Calculate monthly correlations between malaria cases and rainfall over a multi-year period.
2. Determine if there is a lag effect (e.g., correlation with rainfall from previous months).
3. Create a line plot showing how the correlation coefficient changes throughout the year.
4. Identify months when environmental factors are most strongly correlated with malaria cases.

---

### Exercise 2.3: Subgroup Correlation Analysis

```r
# Calculate correlations by region
region_cors <- malaria_analysis %>%
  group_by(region) %>%
  summarise(
    rainfall_cor = cor(cases, rainfall_mm, use = "pairwise.complete.obs"),
    temp_cor = cor(cases, temperature_c, use = "pairwise.complete.obs"),
    humidity_cor = cor(cases, humidity_pct, use = "pairwise.complete.obs"),
    n = n()
  )

print(region_cors)

# Test if correlations differ between regions
# Fisher's z-transformation for comparing correlations
fisher_z <- function(r) 0.5 * log((1 + r) / (1 - r))
z_to_r <- function(z) (exp(2 * z) - 1) / (exp(2 * z) + 1)

region_cors <- region_cors %>%
  mutate(
    rainfall_z = fisher_z(rainfall_cor),
    rainfall_se = 1 / sqrt(n - 3)
  )

# Compare first two regions as an example
region1 <- region_cors[1, ]
region2 <- region_cors[2, ]

z_diff <- (region1$rainfall_z - region2$rainfall_z) / 
          sqrt(region1$rainfall_se^2 + region2$rainfall_se^2)
p_value <- 2 * (1 - pnorm(abs(z_diff)))

cat("Testing if rainfall correlations differ between", 
    region1$region, "and", region2$region, ":\n")
cat("Z difference =", round(z_diff, 2), ", p-value =", round(p_value, 4), "\n")

# Compare urban vs. rural correlations
urban_cor <- malaria_analysis %>%
  filter(area_type == "Urban") %>%
  summarise(
    rainfall_cor = cor(cases, rainfall_mm, use = "pairwise.complete.obs"),
    temp_cor = cor(cases, temperature_c, use = "pairwise.complete.obs"),
    humidity_cor = cor(cases, humidity_pct, use = "pairwise.complete.obs")
  )

rural_cor <- malaria_analysis %>%
  filter(area_type == "Rural") %>%
  summarise(
    rainfall_cor = cor(cases, rainfall_mm, use = "pairwise.complete.obs"),
    temp_cor = cor(cases, temperature_c, use = "pairwise.complete.obs"),
    humidity_cor = cor(cases, humidity_pct, use = "pairwise.complete.obs")
  )

# Combine for visualization
area_cors <- bind_rows(
  mutate(urban_cor, area_type = "Urban"),
  mutate(rural_cor, area_type = "Rural")
)

area_cors_long <- area_cors %>%
  pivot_longer(
    cols = c(rainfall_cor, temp_cor, humidity_cor),
    names_to = "variable",
    values_to = "correlation"
  ) %>%
  mutate(
    variable = case_when(
      variable == "rainfall_cor" ~ "Rainfall",
      variable == "temp_cor" ~ "Temperature",
      variable == "humidity_cor" ~ "Humidity"
    )
  )

# Visualize urban vs. rural correlations
ggplot(area_cors_long, aes(x = variable, y = correlation, fill = area_type)) +
  geom_col(position = "dodge") +
  labs(
    title = "Correlation with Malaria Cases: Urban vs. Rural Areas",
    x = "Environmental Factor",
    y = "Correlation Coefficient",
    fill = "Area Type"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2")

# Regional correlation comparisons
region_cors_long <- region_cors %>%
  select(region, rainfall_cor, temp_cor, humidity_cor) %>%
  pivot_longer(
    cols = c(rainfall_cor, temp_cor, humidity_cor),
    names_to = "variable",
    values_to = "correlation"
  ) %>%
  mutate(
    variable = case_when(
      variable == "rainfall_cor" ~ "Rainfall",
      variable == "temp_cor" ~ "Temperature",
      variable == "humidity_cor" ~ "Humidity"
    )
  )

ggplot(region_cors_long, aes(x = region, y = correlation, fill = variable)) +
  geom_col(position = "dodge") +
  labs(
    title = "Environmental Correlations with Malaria Cases by Region",
    x = "Region",
    y = "Correlation Coefficient",
    fill = "Environmental\nFactor"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set1")
```

#### Explanation:
- We calculate separate correlations for different regions and settings (urban/rural)
- Fisher's z-transformation allows statistical comparison of correlation coefficients
- The bar charts visualize how environmental correlations vary across regions
- Different correlation patterns suggest that environmental factors influence malaria transmission differently across regions
- This helps tailor prediction models to specific contexts
üîπ **Explore how correlations vary across different subgroups.**

**Write the R code to:**
1. Calculate the correlation between malaria cases and rainfall separately for each region.
2. Test if these correlations differ significantly between regions.
3. Investigate if the correlation strength varies by urban vs. rural settings.
4. Create visualizations to compare correlation patterns across different subgroups.

---

## 3Ô∏è‚É£ Linear Regression Models

### Exercise 3.1: Simple Linear Regression

```r
# Create a simple linear regression using rainfall as predictor
simple_model <- lm(cases ~ rainfall_mm, data = malaria_analysis)

# Examine model summary
summary(simple_model)

# Extract key metrics
coefficients <- coef(simple_model)
r_squared <- summary(simple_model)$r.squared
p_value <- summary(simple_model)$coefficients[2, 4]

cat("Rainfall coefficient:", round(coefficients[2], 4), 
    "(p =", round(p_value, 4), ")\n")
cat("Intercept:", round(coefficients[1], 2), "\n")
cat("R-squared:", round(r_squared, 4), "\n")
cat("Interpretation: For each 1mm increase in rainfall, malaria cases increase by", 
    round(coefficients[2], 2), "on average\n")

# Check model assumptions
par(mfrow = c(2, 2))
plot(simple_model)
par(mfrow = c(1, 1))

# Create a scatter plot with regression line
ggplot(malaria_analysis, aes(x = rainfall_mm, y = cases)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", formula = y ~ x, color = "blue", se = TRUE) +
  labs(
    title = "Simple Linear Regression: Malaria Cases vs. Rainfall",
    subtitle = paste("R¬≤ =", round(r_squared, 3), ", p =", round(p_value, 4)),
    x = "Rainfall (mm)",
    y = "Number of Malaria Cases"
  ) +
  theme_minimal() +
  annotate("text", x = max(malaria_analysis$rainfall_mm, na.rm = TRUE) * 0.75, 
           y = max(malaria_analysis$cases, na.rm = TRUE) * 0.25, 
           label = paste("Cases =", round(coefficients[1], 1), "+", 
                        round(coefficients[2], 3), "√ó Rainfall"), 
           hjust = 0)
```

#### Explanation:
- The coefficient for rainfall (slope) indicates how many additional cases are expected per 1mm increase in rainfall
- The p-value tests if this relationship is statistically significant
- R-squared shows the proportion of variance in malaria cases explained by rainfall
- The diagnostic plots help assess if assumptions are met:
  - Residuals vs Fitted: checks linearity and homoscedasticity
  - Normal Q-Q: checks normality of residuals
  - Scale-Location: checks homoscedasticity
  - Residuals vs Leverage: identifies influential points
- The scatter plot visualizes the relationship with the fitted line and confidence intervals
üîπ **Build and interpret basic regression models.**

**Write the R code to:**
1. Create a simple linear regression model using rainfall as a predictor of malaria cases.
2. Interpret the coefficient, p-value, and R-squared value.
3. Check if the model meets the assumptions of linear regression.
4. Create a scatter plot with the regression line and confidence interval.

---

### Exercise 3.2: Multiple Regression Analysis

```r
# Create a multiple regression model
multiple_model <- lm(cases ~ rainfall_mm + temperature_c + humidity_pct, 
                   data = malaria_analysis)

# Examine model summary
summary(multiple_model)

# Check for multicollinearity
library(car)
vif_values <- vif(multiple_model)
print(vif_values)

# Standardized coefficients to compare predictors
library(lm.beta)
std_coef <- lm.beta(multiple_model)
summary(std_coef)

# Compare simple and multiple models
anova_comparison <- anova(simple_model, multiple_model)
print(anova_comparison)

# Calculate adjusted R-squared improvement
r2_simple <- summary(simple_model)$adj.r.squared
r2_multiple <- summary(multiple_model)$adj.r.squared
improvement <- (r2_multiple - r2_simple) / r2_simple * 100

cat("Adjusted R-squared improvement:", round(improvement, 1), "%\n")

# Extract predictions for visualization
malaria_analysis$predicted_simple <- predict(simple_model)
malaria_analysis$predicted_multiple <- predict(multiple_model)
malaria_analysis$residuals_multiple <- residuals(multiple_model)

# Visualize observed vs predicted values
ggplot(malaria_analysis) +
  geom_point(aes(x = cases, y = predicted_simple, color = "Simple Model"), alpha = 0.6) +
  geom_point(aes(x = cases, y = predicted_multiple, color = "Multiple Model"), alpha = 0.6) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  labs(
    title = "Observed vs. Predicted Malaria Cases",
    x = "Observed Cases",
    y = "Predicted Cases",
    color = "Model"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("Simple Model" = "#E69F00", "Multiple Model" = "#56B4E9"))

# Visualize relative importance of predictors
coef_data <- data.frame(
  Variable = c("Rainfall", "Temperature", "Humidity"),
  Standardized_Coefficient = as.numeric(std_coef$standardized.coefficients[-1]),
  StdError = summary(multiple_model)$coefficients[-1, 2] / 
              sd(malaria_analysis$cases, na.rm = TRUE) * 
              sapply(c("rainfall_mm", "temperature_c", "humidity_pct"), 
                     function(x) sd(malaria_analysis[[x]], na.rm = TRUE))
)

ggplot(coef_data, aes(x = reorder(Variable, abs(Standardized_Coefficient)), 
                    y = Standardized_Coefficient)) +
  geom_col(fill = "steelblue") +
  geom_errorbar(aes(ymin = Standardized_Coefficient - StdError, 
                   ymax = Standardized_Coefficient + StdError), width = 0.2) +
  labs(
    title = "Standardized Coefficients from Multiple Regression",
    subtitle = "Larger absolute values indicate stronger predictors",
    x = NULL,
    y = "Standardized Coefficient"
  ) +
  coord_flip() +
  theme_minimal()
```

#### Explanation:
- Multiple regression includes several predictors simultaneously, controlling for each other
- VIF (Variance Inflation Factor) values >5-10 indicate problematic multicollinearity
- Standardized coefficients allow comparison of predictors on different scales
- ANOVA comparison tests whether the multiple model significantly improves over the simple model
- The observed vs. predicted plot shows how well each model fits the data
- The coefficient plot highlights which environmental factors have the strongest association with malaria cases
üîπ **Build more complex models with multiple predictors.**

**Write the R code to:**
1. Develop a multiple regression model with rainfall, temperature, and humidity as predictors.
2. Evaluate which environmental factor has the strongest association with malaria cases.
3. Check for multicollinearity between predictors.
4. Compare the multiple regression model to the simple regression model from Exercise 3.1.

---

### Exercise 3.3: Advanced Regression Modeling

```r
# Create a comprehensive model with interactions
full_model <- lm(cases ~ rainfall_mm * season + temperature_c + humidity_pct + region, 
                data = malaria_analysis)

summary(full_model)

# Check for non-linear relationships
# Create a model with quadratic terms
nonlinear_model <- lm(cases ~ rainfall_mm + I(rainfall_mm^2) + temperature_c + 
                     I(temperature_c^2) + humidity_pct + region + season, 
                     data = malaria_analysis)

summary(nonlinear_model)

# Try log transformation for skewed data
log_model <- lm(log(cases + 1) ~ rainfall_mm + temperature_c + humidity_pct + 
               region + season, data = malaria_analysis)

summary(log_model)

# Model selection with step-wise regression
library(MASS)
step_model <- stepAIC(full_model, direction = "both", trace = FALSE)
summary(step_model)

# Compare all models using AIC
models <- list(
  "Simple" = simple_model,
  "Multiple" = multiple_model,
  "Full" = full_model,
  "Nonlinear" = nonlinear_model,
  "Log" = log_model,
  "Stepwise" = step_model
)

aic_values <- sapply(models, AIC)
bic_values <- sapply(models, BIC)
r2_values <- sapply(models, function(m) summary(m)$adj.r.squared)

model_comparison <- data.frame(
  Model = names(models),
  AIC = aic_values,
  BIC = bic_values,
  Adj_R2 = r2_values
)

model_comparison <- model_comparison %>%
  arrange(AIC)

print(model_comparison)

# Visualize model comparison
model_comparison_long <- model_comparison %>%
  mutate(Model = factor(Model, levels = Model)) %>%
  select(Model, AIC, BIC) %>%
  pivot_longer(
    cols = c(AIC, BIC),
    names_to = "Criterion",
    values_to = "Value"
  )

ggplot(model_comparison_long, aes(x = Model, y = Value, fill = Criterion)) +
  geom_col(position = "dodge") +
  labs(
    title = "Model Comparison: AIC and BIC",
    subtitle = "Lower values indicate better models",
    x = "Model",
    y = "Value"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set1")

# Plot predicted values from the best model
best_model <- models[[model_comparison$Model[1]]]
malaria_analysis$best_predictions <- predict(best_model)

if(model_comparison$Model[1] == "Log") {
  malaria_analysis$best_predictions <- exp(malaria_analysis$best_predictions) - 1
}

ggplot(malaria_analysis, aes(x = cases, y = best_predictions)) +
  geom_point(alpha = 0.6) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(
    title = paste("Best Model:", model_comparison$Model[1]),
    subtitle = paste("Adjusted R¬≤:", round(model_comparison$Adj_R2[1], 3)),
    x = "Observed Cases",
    y = "Predicted Cases"
  ) +
  theme_minimal()
```

#### Explanation:
- Advanced modeling techniques help address non-linear relationships and interactions
- Interaction terms (e.g., `rainfall_mm * season`) test if the effect of rainfall differs by season
- Quadratic terms (e.g., `I(rainfall_mm^2)`) capture non-linear relationships
- Log transformation helps when the outcome is right-skewed or relationships are multiplicative
- Stepwise regression automatically selects variables for inclusion based on statistical criteria
- AIC and BIC are model selection criteria that balance model fit and complexity
- Comparing models helps identify the most parsimonious model that explains the data well
üîπ **Expand your models to include more complex relationships.**

**Write the R code to:**
1. Create a regression model including both environmental factors and categorical variables (region, season).
2. Test for interactions between environmental factors and categorical variables.
3. Consider transformations (log, square root) if the relationship is non-linear.
4. Use model selection techniques to identify the most parsimonious model.

---

## 4Ô∏è‚É£ Interpreting Results for Public Health

### Exercise 4.1: Predicting High-Risk Periods

```r
# Use the best model from previous exercise for predictions
# Let's assume the log_model was best
prediction_model <- log_model

# Create a prediction dataset with different rainfall values
rainfall_range <- seq(min(malaria_analysis$rainfall_mm, na.rm = TRUE),
                     max(malaria_analysis$rainfall_mm, na.rm = TRUE),
                     length.out = 100)

# Create scenarios for predictions
prediction_scenarios <- expand.grid(
  rainfall_mm = rainfall_range,
  temperature_c = mean(malaria_analysis$temperature_c, na.rm = TRUE),
  humidity_pct = mean(malaria_analysis$humidity_pct, na.rm = TRUE),
  region = "Central",
  season = c("Dry", "Wet")
)

# Generate predictions with confidence intervals
predictions <- predict(prediction_model, newdata = prediction_scenarios, 
                     interval = "confidence", level = 0.95)

# Convert from log scale if needed
predictions <- exp(predictions) - 1

# Add predictions to scenarios data
prediction_scenarios <- cbind(prediction_scenarios, predictions)
colnames(prediction_scenarios)[6:8] <- c("predicted", "lwr", "upr")

# Determine rainfall threshold for high risk (>100 cases)
threshold_cases <- 100
threshold_rainfall <- prediction_scenarios %>%
  filter(season == "Wet" & predicted > threshold_cases) %>%
  arrange(rainfall_mm) %>%
  head(1) %>%
  pull(rainfall_mm)

cat("Rainfall threshold for high malaria risk (>100 cases) during wet season:", 
    round(threshold_rainfall, 1), "mm\n")

# Visualize predictions by season
ggplot(prediction_scenarios, aes(x = rainfall_mm, y = predicted, color = season)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = season), alpha = 0.2, color = NA) +
  geom_hline(yintercept = threshold_cases, linetype = "dashed", color = "red") +
  annotate("text", x = min(rainfall_range) + 10, y = threshold_cases + 10, 
          label = "High Risk Threshold", color = "red") +
  labs(
    title = "Predicted Malaria Cases by Rainfall and Season",
    x = "Rainfall (mm)",
    y = "Predicted Cases",
    color = "Season",
    fill = "Season"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1")

# Create a calendar of predicted risk based on historical climate data
monthly_climate <- malaria_analysis %>%
  group_by(month) %>%
  summarise(
    avg_rainfall = mean(rainfall_mm, na.rm = TRUE),
    avg_temp = mean(temperature_c, na.rm = TRUE),
    avg_humidity = mean(humidity_pct, na.rm = TRUE)
  )

# Create prediction dataset for each month
monthly_scenarios <- expand.grid(
  month = 1:12,
  region = unique(malaria_analysis$region)
)

monthly_scenarios <- monthly_scenarios %>%
  left_join(monthly_climate, by = "month") %>%
  mutate(
    rainfall_mm = avg_rainfall,
    temperature_c = avg_temp,
    humidity_pct = avg_humidity,
    season = ifelse(month %in% c(5:10), "Wet", "Dry")
  )

# Generate predictions
monthly_predictions <- predict(prediction_model, newdata = monthly_scenarios)
monthly_scenarios$predicted_cases <- exp(monthly_predictions) - 1

# Assign risk categories
monthly_scenarios <- monthly_scenarios %>%
  mutate(
    risk_category = case_when(
      predicted_cases < 50 ~ "Low",
      predicted_cases < 100 ~ "Medium",
      TRUE ~ "High"
    ),
    month_name = month.name[month]
  )

# Create a risk calendar visualization
ggplot(monthly_scenarios, aes(x = month_name, y = region, fill = risk_category)) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("Low" = "green", "Medium" = "yellow", "High" = "red")) +
  labs(
    title = "Malaria Risk Calendar by Region and Month",
    x = "Month",
    y = "Region",
    fill = "Risk Level"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Explanation:
- We use our statistical model to predict malaria cases under different scenarios
- The rainfall threshold identifies the point where risk becomes high
- Confidence intervals show the uncertainty in our predictions
- The risk calendar provides a month-by-month projection of malaria risk by region
- This information helps plan the timing of interventions and resource allocation
- Color-coding makes it easy for non-specialists to interpret risk levels
üîπ **Use statistical models to identify high-risk conditions.**

**Write the R code to:**
1. Use your best regression model to predict the number of malaria cases under different scenarios.
2. Calculate the threshold values of environmental factors associated with high malaria transmission.
3. Create a calendar of predicted high-risk months based on historical weather patterns.
4. Visualize the predicted seasonal pattern of malaria cases.

---

### Exercise 4.2: Comparing Intervention Effectiveness

```r
# Simulate data for two different interventions
# In real scenario, you would use actual intervention data
intervention_data <- malaria_analysis %>%
  filter(period %in% c("Before_nets", "After_nets")) %>%
  mutate(
    intervention = ifelse(period == "Before_nets", "No Intervention", "Bed Nets")
  ) %>%
  select(region, year, month, cases, intervention, rainfall_mm, temperature_c, humidity_pct)

# Add a second intervention (simulated)
second_intervention <- malaria_analysis %>%
  filter(period == "After_nets") %>%
  mutate(
    intervention = "Spraying",
    cases = cases * runif(n(), 0.7, 0.9)  # Simulate 10-30% reduction compared to bed nets
  ) %>%
  select(region, year, month, cases, intervention, rainfall_mm, temperature_c, humidity_pct)

# Combine data
intervention_comparison <- bind_rows(intervention_data, second_intervention)

# Compare interventions with t-tests
baseline <- intervention_comparison %>% 
  filter(intervention == "No Intervention") %>%
  pull(cases)

nets <- intervention_comparison %>% 
  filter(intervention == "Bed Nets") %>%
  pull(cases)

spraying <- intervention_comparison %>% 
  filter(intervention == "Spraying") %>%
  pull(cases)

nets_vs_baseline <- t.test(nets, baseline, paired = TRUE)
spray_vs_baseline <- t.test(spraying, baseline, paired = TRUE)
nets_vs_spray <- t.test(nets, spraying, paired = TRUE)

# Calculate percent reduction
percent_reduction <- data.frame(
  Intervention = c("Bed Nets", "Spraying"),
  Mean_Before = mean(baseline),
  Mean_After = c(mean(nets), mean(spraying)),
  Reduction_Percent = c(
    (mean(baseline) - mean(nets)) / mean(baseline) * 100,
    (mean(baseline) - mean(spraying)) / mean(baseline) * 100
  ),
  P_Value = c(nets_vs_baseline$p.value, spray_vs_baseline$p.value)
)

print(percent_reduction)

# Build regression model to control for confounding factors
intervention_effect_model <- lm(cases ~ intervention + rainfall_mm + temperature_c + 
                              humidity_pct + region, 
                              data = intervention_comparison)

summary(intervention_effect_model)

# Extract intervention effects with confidence intervals
library(broom)
model_results <- tidy(intervention_effect_model, conf.int = TRUE) %>%
  filter(grepl("intervention", term)) %>%
  mutate(
    term = gsub("intervention", "", term),
    effect_percent = estimate / mean(baseline) * 100,
    lower_percent = conf.low / mean(baseline) * 100,
    upper_percent = conf.high / mean(baseline) * 100
  )

# Create forest plot of intervention effects
ggplot(model_results, aes(x = term, y = effect_percent)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lower_percent, ymax = upper_percent), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(
    title = "Effect of Interventions on Malaria Cases",
    subtitle = "Adjusted for rainfall, temperature, humidity, and region",
    x = "Intervention",
    y = "Percent Change in Cases"
  ) +
  coord_flip() +
  theme_minimal() +
  scale_y_continuous(labels = function(x) paste0(x, "%"))

# Compare interventions by region
regional_effects <- intervention_comparison %>%
  group_by(region, intervention) %>%
  summarise(
    mean_cases = mean(cases, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = intervention,
    values_from = mean_cases
  ) %>%
  mutate(
    nets_reduction = (`No Intervention` - `Bed Nets`) / `No Intervention` * 100,
    spraying_reduction = (`No Intervention` - Spraying) / `No Intervention` * 100
  )

print(regional_effects)

# Visualize regional differences in intervention effectiveness
regional_effects_long <- regional_effects %>%
  select(region, nets_reduction, spraying_reduction) %>%
  pivot_longer(
    cols = c(nets_reduction, spraying_reduction),
    names_to = "intervention",
    values_to = "percent_reduction"
  ) %>%
  mutate(
    intervention = gsub("_reduction", "", intervention)
  )

ggplot(regional_effects_long, aes(x = region, y = percent_reduction, fill = intervention)) +
  geom_col(position = "dodge") +
  labs(
    title = "Intervention Effectiveness by Region",
    x = "Region",
    y = "Percent Reduction in Cases",
    fill = "Intervention"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set1") +
  scale_y_continuous(labels = function(x) paste0(x, "%"))
```

#### Explanation:
- We compare the effectiveness of different interventions using statistical tests
- Percent reduction shows the practical impact of each intervention
- Regression models help control for confounding factors like rainfall or temperature
- The forest plot visually compares interventions with confidence intervals
- Regional analysis shows if interventions work better in some areas than others
- This information helps decision-makers select the most effective interventions for each context
üîπ **Analyze the impact of different malaria control interventions.**

**Write the R code to:**
1. Compare the effectiveness of two different interventions using appropriate statistical tests.
2. Calculate the percent reduction in cases associated with each intervention.
3. Build a regression model that controls for confounding factors when evaluating interventions.
4. Create a forest plot showing the estimated effect of each intervention with confidence intervals.

---

### Exercise 4.3: Creating a Risk Assessment Tool

```r
# Create a function to classify malaria risk based on environmental inputs
predict_malaria_risk <- function(rainfall, temperature, humidity, 
                               region = "Central", season = "Wet") {
  
  # Create a data frame with inputs
  new_data <- data.frame(
    rainfall_mm = rainfall,
    temperature_c = temperature,
    humidity_pct = humidity,
    region = region,
    season = season
  )
  
  # Generate prediction using our model
  predicted_cases <- predict(prediction_model, newdata = new_data)
  
  # Convert from log scale if using log model
  predicted_cases <- exp(predicted_cases) - 1
  
  # Classify risk level
  risk_level <- case_when(
    predicted_cases < 50 ~ "Low Risk",
    predicted_cases < 100 ~ "Medium Risk",
    TRUE ~ "High Risk"
  )
  
  # Return result
  return(list(
    predicted_cases = round(predicted_cases, 1),
    risk_level = risk_level
  ))
}

# Test the function
test_result <- predict_malaria_risk(
  rainfall = 150, 
  temperature = 28, 
  humidity = 75,
  region = "Central",
  season = "Wet"
)

print(test_result)

# Generate a risk map for different environmental conditions
risk_grid <- expand.grid(
  rainfall_mm = seq(50, 250, by = 25),
  temperature_c = seq(22, 32, by = 2),
  humidity_pct = mean(malaria_analysis$humidity_pct, na.rm = TRUE),
  region = "Central",
  season = "Wet"
)

# Generate predictions for each grid point
risk_grid$predicted <- predict(prediction_model, newdata = risk_grid)
risk_grid$predicted <- exp(risk_grid$predicted) - 1
risk_grid$risk_level <- case_when(
  risk_grid$predicted < 50 ~ "Low Risk",
  risk_grid$predicted < 100 ~ "Medium Risk",
  TRUE ~ "High Risk"
)

# Convert risk level to factor with ordered levels
risk_grid$risk_level <- factor(risk_grid$risk_level, 
                             levels = c("Low Risk", "Medium Risk", "High Risk"))

# Create risk map visualization
ggplot(risk_grid, aes(x = rainfall_mm, y = temperature_c, fill = risk_level)) +
  geom_tile() +
  scale_fill_manual(values = c("Low Risk" = "green", 
                              "Medium Risk" = "yellow", 
                              "High Risk" = "red")) +
  labs(
    title = "Malaria Risk Map by Rainfall and Temperature",
    subtitle = paste("Humidity fixed at", 
                    round(mean(malaria_analysis$humidity_pct, na.rm = TRUE)), "%"),
    x = "Rainfall (mm)",
    y = "Temperature (¬∞C)",
    fill = "Risk Level"
  ) +
  theme_minimal() +
  guides(fill = guide_legend(title = "Risk Level"))

# Evaluate the performance of the risk classification system
# (In practice, we would use test data not used in model building)
malaria_analysis$predicted_cases <- predict(prediction_model, newdata = malaria_analysis)
malaria_analysis$predicted_cases <- exp(malaria_analysis$predicted_cases) - 1

malaria_analysis$actual_risk <- case_when(
  malaria_analysis$cases < 50 ~ "Low Risk",
  malaria_analysis$cases < 100 ~ "Medium Risk",
  TRUE ~ "High Risk"
)

malaria_analysis$predicted_risk <- case_when(
  malaria_analysis$predicted_cases < 50 ~ "Low Risk",
  malaria_analysis$predicted_cases < 100 ~ "Medium Risk",
  TRUE ~ "High Risk"
)

# Create confusion matrix
conf_matrix <- table(
  Actual = malaria_analysis$actual_risk,
  Predicted = malaria_analysis$predicted_risk
)

print(conf_matrix)

# Calculate performance metrics
sensitivity <- diag(conf_matrix) / rowSums(conf_matrix)
specificity <- function(cm, class) {
  # For multiclass, specificity is calculated for each class
  tp <- cm[class, class]
  fp <- sum(cm[-which(rownames(cm) == class), class])
  tn <- sum(cm[-which(rownames(cm) == class), -which(colnames(cm) == class)])
  fn <- sum(cm[class, -which(colnames(cm) == class)])
  return(tn / (tn + fp))
}

# Calculate for each risk level
specificity_values <- sapply(rownames(conf_matrix), function(class) {
  specificity(conf_matrix, class)
})

# Create performance summary
performance <- data.frame(
  Risk_Level = rownames(conf_matrix),
  Sensitivity = sensitivity,
  Specificity = specificity_values
)

print(performance)

# Create visual summary of risk factors
var_importance <- data.frame(
  Variable = c("Rainfall", "Temperature", "Humidity", "Season (Wet vs Dry)", "Region"),
  Importance = c(0.45, 0.30, 0.15, 0.07, 0.03),  # These would come from model coefficients
  Description = c(
    "Strong positive association. 150mm+ is high risk.",
    "Positive association. 28¬∞C+ is high risk when combined with rainfall.",
    "Moderate positive association.",
    "Wet season increases risk by 40% compared to dry season.",
    "Central and Eastern regions have highest baseline risk."
  )
)

# Create visual summary for stakeholders
ggplot(var_importance, aes(x = reorder(Variable, Importance), y = Importance)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Relative Importance of Malaria Risk Factors",
    x = NULL,
    y = "Relative Importance"
  ) +
  theme_minimal() +
  geom_text(aes(label = Description), hjust = -0.05, size = 3) +
  scale_y_continuous(limits = c(0, 0.6))
```

#### Explanation:
- The risk assessment function converts environmental data into practical risk levels
- The risk map visualizes how different combinations of rainfall and temperature affect malaria risk
- Sensitivity measures how well we detect high-risk situations (true positive rate)
- Specificity measures how well we avoid false alarms (true negative rate)
- The visual summary of risk factors helps communicate key findings to stakeholders
- This risk assessment tool can guide decision-making for malaria control programs
üîπ **Develop a tool to classify malaria risk based on your models.**

**Write the R code to:**
1. Create a function that classifies malaria risk as low, medium, or high based on environmental inputs.
2. Generate a risk map showing predicted risk levels across different regions and seasons.
3. Calculate the sensitivity and specificity of your risk classification system.
4. Design a clear visual summary of risk factors and their relative importance for stakeholders.

---

# üìå Week 6: Solutions ‚Äì Statistical Analysis for Malaria Data

Here are the **solutions** for Week 6 exercises:

---

## 1Ô∏è‚É£ Comparing Malaria Data: t-tests and ANOVA

### Exercise 1.1: Basic Comparative Tests

```r
# Load required packages
library(dplyr)
library(ggplot2)

# Load the dataset
malaria_analysis <- read.csv("malaria_analysis.csv")

# 1. Test if there is a significant difference between urban and rural areas
urban_cases <- malaria_analysis %>% 
  filter(area_type == "Urban") %>%
  pull(cases)

rural_cases <- malaria_analysis %>% 
  filter(area_type == "Rural") %>%
  pull(cases)

urban_rural_test <- t.test(urban_cases, rural_cases)
print(urban_rural_test)

# Visualize the comparison
ggplot(malaria_analysis, aes(x = area_type, y = cases, fill = area_type)) +
  geom_boxplot() +
  labs(
    title = "Malaria Cases by Area Type",
    subtitle = paste("p-value =", round(urban_rural_test$p.value, 4)),
    x = "Area Type",
    y = "Number of Cases"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2")

# 2. Compare incidence rates before and after bed net introduction
before_nets <- malaria_analysis %>%
  filter(period == "Before_nets") %>%
  pull(incidence_per_1000)

after_nets <- malaria_analysis %>%
  filter(period == "After_nets") %>%
  pull(incidence_per_1000)

nets_test <- t.test(before_nets, after_nets, paired = TRUE)
print(nets_test)

# Visualize the before-after comparison
nets_data <- data.frame(
  Period = rep(c("Before Nets", "After Nets"), each = length(before_nets)),
  Incidence = c(before_nets, after_nets)
)

ggplot(nets_data, aes(x = Period, y = Incidence, fill = Period)) +
  geom_boxplot() +
  labs(
    title = "Impact of Bed Nets on Malaria Incidence",
    subtitle = paste("p-value =", round(nets_test$p.value, 4)),
    y = "Incidence per 1000 Population"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("Before Nets" = "#E69F00", "After Nets" = "#56B4E9"))

# 3. Compare wet and dry seasons
wet_cases <- malaria_analysis %>%
  filter(season == "Wet") %>%
  pull(cases)

dry_cases <- malaria_analysis %>%
  filter(season == "Dry") %>%
  pull(cases)

season_test <- t.test(wet_cases, dry_cases)
print(season_test)

# Visualize seasonal differences
ggplot(malaria_analysis, aes(x = season, y = cases, fill = season)) +
  geom_violin(alpha = 0.7) +
  geom_boxplot(width = 0.2, alpha = 0.7) +
  labs(
    title = "Malaria Cases by Season",
    subtitle = paste("p-value =", round(season_test$p.value, 4)),
    x = "Season",
    y = "Number of Cases"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("Dry" = "#D55E00", "Wet" = "#0072B2"))
```

#### Explanation:
- ANOVA tests if means differ significantly across multiple groups (regions in this case)
- The `summary(region_anova)` shows if there's a significant overall difference 
- Tukey's test performs pairwise comparisons to identify which specific regions differ
- Confidence intervals show the precision of our mean estimates
- Error bars help visualize the uncertainty in our estimates of regional means
- We use `t.test()` to compare means between two groups.
- For bed nets, we used a paired t-test since measurements are from the same locations before and after.
- Box plots visualize the distribution of cases in each group.
- Violin plots show both the distribution and density of values in each season.
- The p-values indicate whether differences are statistically significant.

---

### Exercise 1.2: Multiple Group Comparisons

```r
# One-way ANOVA to compare cases across regions
region_anova <- aov(cases ~ region, data = malaria_analysis)
summary(region_anova)

# Perform post-hoc tests
tukey_result <- TukeyHSD(region_anova)
print(tukey_result)

# Visualize regional differences
region_summary <- malaria_analysis %>%
  group_by(region) %>%
  summarise(
    mean_cases = mean(cases, na.rm = TRUE),
    sd_cases = sd(cases, na.rm = TRUE),
    n = n(),
    se = sd_cases / sqrt(n),
    lower_ci = mean_cases - qt(0.975, n-1) * se,
    upper_ci = mean_cases + qt(0.975, n-1) * se
  ) %>%
  arrange(desc(mean_cases))

print(region_summary)

# Create visualization with error bars
ggplot(region_summary, aes(x = reorder(region, -mean_cases), y = mean_cases, fill = region)) +
  geom_col() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), width = 0.2) +
  labs(
    title = "Malaria Cases by Region with 95% Confidence Intervals",
    x = "Region",
    y = "Mean Number of Cases"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set3")

# Box plot of cases by region
ggplot(malaria_analysis, aes(x = region, y = cases, fill = region)) +
  geom_boxplot() +
  labs(
    title = "Distribution of Malaria Cases by Region",
    x = "Region",
    y = "Number of Cases"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set3")
